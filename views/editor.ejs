<% include part/header %>
<style media="screen">
  #display {
    background-color: rgba(25, 25, 25, .85);
    border-radius: 10px;
    box-shadow: 0 5px 7px #000;
    padding: 10px;
  }
</style>

<script type="text/javascript">
  function run() {
    var text = document.getElementById('sourceTA').value,
        target = document.getElementById('targetDiv'),
        converter = new showdown.Converter(),
        html = converter.makeHtml(text);

      target.innerHTML = html;
    }

    $().ready(function() {
      run();
    });

</script>

<br>
<div class="container" id='display'>
  <nav aria-label="breadcrumb">
    <ol class='breadcrumb'>
      <li class='breadcrumb-item active'>Tags:</li>
    </ol>
  </nav>
  <form class="form" action="/doc/<%= doc._id %>/update" method="post">
  <input class='form-control' type="text" name="docInfo[title]" value="<%= doc.title %>" placeholder="Title">
  <br>
  <input id='tagIDs' type="hidden" name='docInfo[category]' name="" value="<%= doc.category %>">

  <textarea name="docInfo[body]" class="form-control" id="sourceTA" rows="19" cols="82"><%= doc.body %></textarea>
  <hr/>
  <button class='btn btn-success text-center' id="sbmt">Submit</button>
  <a href="#" onClick="run()" class='btn btn-primary pull-right' data-toggle='modal' data-target="#previewModal"> Preview </a>
  </form>


</div>

<div class="modal fade" id="addTagModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Tag</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="list-group" id='tagList'>
          <!--   Tag list generated by script   -->
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="previewModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Preview</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="targetDiv" >
            <h1 class="text-center">Nothing Yet</h1>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  var loadedCats = $("#tagIDs").val();
  loadedCats.split(";").forEach(function(aTag) {
    if(aTag != 'none'){
      addTag(aTag);
    }
  });

  function getTags(){
    $("#tagList").html("");
    var tags = $('#tagIDs').val();
    var parentID = tags.split(";").pop();
    $.ajax({
      url: "/tags/" + parentID + "/parent",
      success: function(data){
        data.forEach(function(tag) {
          var temp = "<a class='list-group-item' data-id='" + tag._id + "'>" + tag.name + "</a>";
          $('#tagList').append(temp);

        });
      },
      complete: function(){
        $('#addTagModal').modal('show');
        $('.list-group-item').on("click", function(e) {
          var tmp = $(e.target).data("id");
          addTag(tmp);
        });
      }
    });
  }

  function addTag(id) {
    if(id != "none"){
      $.ajax({
        url: "/tags/" + id + "/load",
        success: function (data){
            $("ol.breadcrumb > li:last-child").remove();
            $('.breadcrumb-item').removeClass('active');
            var temp = "<li class='breadcrumb-item active'> <a data-tag='" + data._id + "'>" + data.name + "</a></li>";
            var current = $("#tagIDs");
            current.val(current.val() + ";" + data._id);
            $("ol.breadcrumb").append(temp);
            appendLink();
        },
        complete: function() {
          $("#addTagModal").modal("hide");
        }
      });
    }
  }


  function appendLink(){
    var link = "<li class='breadcrumb-item'><a href='javascript:getTags()'>[ Add ]</a></li>";
    $('ol.breadcrumb').append(link);
  }
  appendLink();
</script>

<% include part/footer %>
