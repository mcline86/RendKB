<% include part/header %>

<script type="text/javascript">
  function run() {
    var text = document.getElementById('sourceTA').value,
        target = document.getElementById('targetDiv'),
        converter = new showdown.Converter(),
        html = converter.makeHtml(text);

      target.innerHTML = html;
    }

    $().ready(function() {
      run();
    });

</script>

<br><br>
<div class="container">
  <nav aria-label="breadcrumb">
    <ol class='breadcrumb'>
      <li class='breadcrumb-item active'>Tags:</li>
    </ol>
  </nav>
  <form class="form" action="/doc/<%= doc._id %>/update" method="post">
  <input class='form-control' type="text" name="docInfo[title]" value="<%= doc.title %>" placeholder="Title">
  <br>
  <input id='tagIDs' type="hidden" name='docInfo[category]' name="" value="none">
  <textarea name="docInfo[body]" class="form-control" id="sourceTA" rows="10" cols="82"><%= doc.body %></textarea>
  <hr/>
  <button class='btn btn-success text-center' id="sbmt">Submit</button>
  </form>
  <button class='btn btn-success' id="runBtn" onClick="run()">Preview</button>
  <hr/>
  <div id="targetDiv" >
      <h1 class="text-center">Nothing Yet</h1>
  </div>
</div>

<div class="modal fade" id="addTagModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Tag</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="list-group" id='tagList'>
          <!--   Tag list generated by script   -->
        </div>
      </div>
    </div>
  </div>
</div>


<script type="text/javascript">
  function getTags(){
    $("#tagList").html("");
    var tags = $('#tagIDs').val();
    var parentID = tags.split(";").pop();
    $.ajax({
      url: "/tags/" + parentID + "/parent",
      success: function(data){
        data.forEach(function(tag) {
          var temp = "<a class='list-group-item' href='javascript:addTag('"+ tag._id +"')'>" + tag.name + "</a>";
          $('#tagList').append(temp);
        });
      },
      complete: function(){
        $('#addTagModal').modal('show');
      }
    });
  }

  function addTag(id) {
    if(id != "none"){
      $.ajax({
        url: "/tags/" + id + "/load",
        success: function (data){
            $("ol.breadcrumb > li:last-child").remove();
            $('.breadcrumb-item').removeClass('active');
            var temp = "<li class='breadcrumb-item active'>" + data.name + "</li>";
            var current = $("#tagIDs");
            current.val(current.val() + ";" + data._id);
            $("ol.breadcrumb").append(temp);
            appendLink();
        }
      });
    }
  }

  function appendLink(){
    var link = "<li class='breadcrumb-item'><a href='javascript:getTags()'>[ Add ]</a></li>";
    $('ol.breadcrumb').append(link);
  }
  appendLink();
</script>

<% include part/footer %>
